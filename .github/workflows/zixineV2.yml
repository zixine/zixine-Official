name: Build zixineKernel-V2-SukiSUxSF

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG_NAME:
        description: 'Defconfig name (e.g., vendor/lito_defconfig atau arch/arm64/configs/gki_defconfig)'
        required: true
        default: 'arch/arm64/configs/gki_defconfig' # Default diubah ke path penuh

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KERNEL_NAME: "Zixine-SukiSUxSF-V2"
      
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      # --- LANGKAH PENTING BARU: Force Submodule/GKI Sync ---
      - name: Force GKI Submodule Initialization (Crucial Fix)
        run: |
          echo "Ensuring all submodules and GKI directories are present..."
          # Perintah ini akan memastikan submodul ditarik, termasuk folder 'common' jika itu submodul.
          git submodule update --init --recursive || true
          # Jika Anda menggunakan manifest/repo, Anda mungkin perlu perintah repo init/sync di sini.
          # Asumsi: kernel source GKI berada di folder 'common' setelah checkout.
          
          # Cek keberadaan file sebelum patching
          if [ ! -f "common/kernel/module.c" ]; then
              echo "ERROR: common/kernel/module.c TIDAK DITEMUKAN. Periksa struktur repositori Anda."
              # Jika ini GKI Manifest, Anda mungkin perlu langkah 'repo sync' di sini.
              exit 1
          fi

      - name: Apply Xiaomi DRM/Flicker Fix (Final Check)
        run: |
          echo "Applying DRM compatibility patches for Xiaomi devices (Garnet/Marble fix)..."
          
          # 1. Hapus cek versi simbol di common/kernel/module.c
          sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' common/kernel/module.c
          
          # 2. Hapus cek valid clones di common/drivers/gpu/drm/drm_atomic_helper.c
          sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' common/drivers/gpu/drm/drm_atomic_helper.c
          sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' common/drivers/gpu/drm/drm_atomic_helper.c
          
          echo "Xiaomi DRM fixes applied successfully."

      - name: Install Dependencies
        # (Tetap sama)
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev git curl \
          python3 python3-pip lld zip unzip libncurses5-dev \
          libelf-dev zlib1g-dev dwarves

      - name: Setup Toolchain (Clang 20)
        # (Tetap sama)
        run: |
          TOOLCHAIN_DIR="$(pwd)/toolchain"
          mkdir -p "$TOOLCHAIN_DIR/clang"
          CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
          
          echo "Downloading Clang 20..."
          curl -L "${CLANG_URL}" | tar -xz -C "$TOOLCHAIN_DIR/clang"
          
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "CLANG_DIR=$TOOLCHAIN_DIR/clang" >> $GITHUB_ENV
          echo "PATH=$TOOLCHAIN_DIR/clang/bin:$PATH" >> $GITHUB_ENV

      - name: Prepare & Configure Kernel (Defconfig & Tweaks)
        run: |
          # VARIABEL LINGKUNGAN WAJIB UNTUK LLVM/CLANG
          export ARCH=arm64
          export LLVM=1
          export CLANG_TRIPLE=aarch64-linux-gnu- 
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          echo "Generating defconfig: ${{ inputs.DEFCONFIG_NAME }}"
          # Defconfig menggunakan O=out
          make O=out ${{ inputs.DEFCONFIG_NAME }}

          # --- Custom Configs (Tweak Performa) ---
          if [ -f out/.config ]; then
            echo "Applying Custom Configs and Performance Tweaks..."
            
            # ... (Semua tweaks konfigurasi yang diminta: Kyber, BBR, HZ 300)
            scripts/config --file out/.config --set-str LOCALVERSION "-${KERNEL_NAME}"
            scripts/config --file out/.config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
            scripts/config --file out/.config -e KPM
            scripts/config --file out/.config -d SYSTEM_TRUSTED_KEYS -d SYSTEM_REVOCATION_KEYS
            scripts/config --file out/.config -e BLK_MQ_SCHED_KYBER
            scripts/config --file out/.config -d HZ_100 -d HZ_250 -d HZ_1000 -d HZ_1200 -e HZ_300
            scripts/config --file out/.config -e TCP_CONG_BBR -e TCP_FASTOPEN -e TCP_CONG_ADVANCED --set-str DEFAULT_TCP_CONG "bbr"
            
            # Simpan perubahan konfigurasi
            make O=out savedefconfig
            mv out/defconfig out/.config
          else
             echo "ERROR: Defconfig creation failed. Check the name: ${{ inputs.DEFCONFIG_NAME }}"
             exit 1 
          fi


      - name: Build Kernel Image
        # (Tetap sama)
        run: |
          export ARCH=arm64
          export LLVM=1
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          echo "Starting Build..."
          make -j"$(nproc --all)" O=out Image \
          LLVM=1 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          LD=ld.lld

      - name: Apply SukiSU Patch
        # (Tetap sama)
        run: |
          cd out/arch/arm64/boot
          
          echo "Downloading SukiSU Patcher..."
          curl -LSs "https://github.com/SukiSU-Ultra/SukiSU_patch/raw/refs/heads/main/kpm/patch_linux" -o patch
          chmod 777 patch
          
          echo "Running Patch..."
          ./patch
          
          if [ -f oImage ]; then
            echo "Patch success! Renaming oImage to Image..."
            mv -f oImage Image
          else
            echo "WARNING: oImage not found. Check if patch failed."
          fi
          
          ls -lh Image

      - name: Check Kernel Version Name
        # (Tetap sama)
        run: |
          strings out/arch/arm64/boot/Image | grep "Linux version" | head -n 1

      - name: Upload Artifact
        # (Tetap sama)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_NAME }}-Image
          path: out/arch/arm64/boot/Image
          compression-level: 9
